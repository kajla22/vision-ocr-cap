pipeline {
    agent any

    environment {
        AZURE_CLIENT_ID       = credentials('AZURE_CLIENT_ID')
        AZURE_CLIENT_SECRET   = credentials('AZURE_CLIENT_SECRET')
        AZURE_TENANT_ID       = credentials('AZURE_TENANT_ID')
        AZURE_SUBSCRIPTION_ID = credentials('AZURE_SUBSCRIPTION_ID')

        TF_IN_AUTOMATION = "true"
        ARM_CLIENT_ID       = "${AZURE_CLIENT_ID}"
        ARM_CLIENT_SECRET   = "${AZURE_CLIENT_SECRET}"
        ARM_TENANT_ID       = "${AZURE_TENANT_ID}"
        ARM_SUBSCRIPTION_ID = "${AZURE_SUBSCRIPTION_ID}"
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Azure Login') {
            steps {
                sh '''
                az login --service-principal \
                  --username "$AZURE_CLIENT_ID" \
                  --password "$AZURE_CLIENT_SECRET" \
                  --tenant "$AZURE_TENANT_ID"

                az account set --subscription "$AZURE_SUBSCRIPTION_ID"
                '''
            }
        }

        stage('Terraform Init') {
            steps {
                dir('terraform') {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Validate') {
            steps {
                dir('terraform') {
                    sh 'terraform validate'
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                dir('terraform') {
                    sh 'terraform plan -out=tfplan'
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('terraform') {
                    sh 'terraform apply -auto-approve tfplan'
                }
            }
        }

        stage('Build Azure Function') {
            steps {
                dir('function-app') {
                    sh '''
                    python3 -m venv .venv
                    . .venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                    '''
                }
            }
        }

        stage('Deploy Azure Function') {
            steps {
                dir('function-app') {
                    sh '''
                    func azure functionapp publish vision-ocr-function \
                      --python
                    '''
                }
            }
        }

        stage('Deploy Frontend (Static Web App)') {
            steps {
                dir('frontend') {
                    sh '''
                    az storage blob upload-batch \
                      --account-name mystorageaccount \
                      --destination '$web' \
                      --source .
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment completed successfully"
        }
        failure {
            echo "❌ Deployment failed"
        }
    }
}
